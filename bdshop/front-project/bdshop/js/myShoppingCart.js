define(["jquery","components","common","weui","hammer","template","updown"],function(t,e,n,o,s,i,a){function r(t){var e,n;new Hammer(t[0],{domEvents:!0}),t.on("panstart",function(o){e=t.children("div.touchModel"),n=parseInt(e.css("transform").replace(/[^0-9\-,]/g,"").split(",")[4],10)}),t.on("pan",function(t){var o=n+t.originalEvent.gesture.deltaX;o>=-110&&o<=0&&e.css("transform","translateX("+o+"px)")})}function p(){var t=$("#shopping_isbuy_allOrNotall").parent(".text");$(".shopping_isbuy_img").attr("src","/pages/bdshop/image/un-choose.png"),t.removeClass("selected")}function c(t,n,o){if(1!=f){f=!0;var s="shopping_edit_"+n,i="shopping_sub_"+n;1==o&&(s="edit_"+n,i="sub_"+n);var a=$("#"+s).val();a=parseInt(a),(isNaN(a)||a<0)&&(a=0),1==t?a=parseInt(a)+parseInt(1):2==t&&(a=parseInt(a)-parseInt(1)),a>1e4&&(a=1e4);var r=apiUrl+"/front/shoppingcart/shoppingcart/editNumeberToShoppingCart?priceId="+n+"&quantity="+a;e.getMsg(r).done(function(t){f=!1,d();var e=t.res;1==e?(0==a?(document.getElementById(i).style.display="none",document.getElementById(s).style.display="none",document.getElementById("shopping_isbuy_"+n).src="/pages/bdshop/image/un-choose.png",document.getElementById("div_"+n).style.display="none",$.toast("删除成功","text")):(document.getElementById(i).style.display="block",document.getElementById(s).style.display="block",document.getElementById("shopping_isbuy_"+n).src="/pages/bdshop/image/choose.png"),$("#"+s).val(a)):alert("直接修改数量操作失败！")})}}function l(t,e){c(t,e,0)}function d(){var t=apiUrl+"/front/shoppingcart/shoppingcart/queryCurrentUserTotalPriceAndCategory";e.getMsg(t).done(function(t){var e=t.res;if(1==e){var n=t.obj;document.getElementById("totalNumber").innerHTML=n.totalPrice/100*1,document.getElementById("totalCategory").innerHTML=n.totalCategory,g()}else alert("获取总价失败！")})}function g(){var t=document.getElementById("totalNumber").innerHTML,e=(100*t-100*settleAccountsPrice)/100;e=parseFloat(e.toFixed(2)),e>=0?(document.getElementById("settle_accounts").innerHTML="结算",document.getElementById("settle_accounts").style.backgroundColor="#2CC17B",document.getElementById("settle_accounts").setAttribute("href","/pages/bdshop/page/order_submit.html")):parseInt(-e)===parseInt(settleAccountsPrice)?(document.getElementById("settle_accounts").innerHTML="¥"+settleAccountsPrice+"起送",document.getElementById("settle_accounts").removeAttribute("href"),document.getElementById("settle_accounts").style.backgroundColor="#CCC"):(document.getElementById("settle_accounts").innerHTML="还差¥"+e*-1+"起送",document.getElementById("settle_accounts").removeAttribute("href"),document.getElementById("settle_accounts").style.backgroundColor="#CCC")}function u(t){var n=apiUrl+"/front/shoppingcart/shoppingcart/reSetIsBuyState?isBuy="+t;e.getMsg(n).done(function(e){var n=e.res;if(1==n){document.getElementById("shopping_isbuy_allOrNotall").src;1==t?(document.getElementById("shopping_isbuy_allOrNotall").src="/pages/bdshop/image/choose.png",$(".shopping_isbuy_img").attr("src","/pages/bdshop/image/choose.png")):(document.getElementById("shopping_isbuy_allOrNotall").src="/pages/bdshop/image/un-choose.png",$(".shopping_isbuy_img").attr("src","/pages/bdshop/image/un-choose.png")),d()}})}function h(t){var n=apiUrl+"/front/shoppingcart/shoppingcart/invertIsBuy?priceId="+t;e.getMsg(n).done(function(e){var n=e.res;if(1==n){var o=document.getElementById("shopping_isbuy_"+t).src;o.indexOf("un-choose")!=-1?document.getElementById("shopping_isbuy_"+t).src="/pages/bdshop/image/choose.png":document.getElementById("shopping_isbuy_"+t).src="/pages/bdshop/image/un-choose.png",d()}})}function m(){$.confirm({title:"提示",text:"是否清空购物车?",onOK:function(){var t=apiUrl+"/front/shoppingcart/shoppingcart/delCurrentUserAllShoppingCart";e.getMsg(t).done(function(t){var e=t.res;1==e&&(d(),v=0,C.unlock(),C.noData(!1),C.$domDown.html(C.opts.domDown.domLoad),C.loading=!0,C.opts.loadDownFn(C))})},onCancel:function(){}})}function _(){$("#show_shoppingCartVO li").click(function(t){var e=$(this).attr("rid");($(t.target).hasClass("delete")||$(t.target).hasClass("icon-delete"))&&$.confirm({text:"确定要删除此规格吗？",onOK:function(){$("#shopping_edit_"+e).val(0),c(3,e,0),document.getElementById("div_"+e).style.display="none",$.toast("删除成功","text")}})})}var y=apiUrlPic,f=!1,b=!0;$("#dialogDetail").css("height",document.documentElement.clientHeight-90);var v=0,I=100,C=$("#dialogDetail").dropload({size:5,categoryId:"0",autoLoad:!1,domDown:{domNoData:'<div class="dropload-noData">没有了~</div>'},loadDownFn:function(t){v++;var e="";$.ajax({type:"GET",url:apiUrl+"/front/shoppingcart/shoppingcart/queryShoppingCartDetailVO",data:"pageNo="+v+"&pageSize="+I,dataType:"json",xhrFields:{withCredentials:!0},crossDomain:!0,success:function(n){var o=n.res,s=n.obj.dataList;if(n=n.obj,n.shoppingCartVODataList=s,1==o&&s.length>0){for(var a=0;a<n.shoppingCartVODataList.length;a++){if(""!==n.shoppingCartVODataList[a].image){n.shoppingCartVODataList[a].image=n.shoppingCartVODataList[a].image.split(",");for(var p=0;p<n.shoppingCartVODataList[a].image.length;p++)n.shoppingCartVODataList[a].image[p]=y+n.shoppingCartVODataList[a].image[p]}n.shoppingCartVODataList[a].retailPrice=n.shoppingCartVODataList[a].retailPrice/100}e=i("show_shoppingCartVO-tpl",n)}else{if(!(v>1))return $(".cart_body,.cart_footer").hide(),void $("#noshoppingCartInfo").show();t.lock()}$("#show_shoppingCartVO").append(e),t.resetload();for(var c in s)$("#shopping_sub_"+s[c].priceId).click(function(){var t=this.id.substring(13),e="shopping_edit_"+t,n=$("#"+e).val();n=parseInt(n),(isNaN(n)||n<0)&&(n=0),n<=1?$.confirm({text:"确定要删除此规格吗？",onOK:function(){$("#shopping_edit_"+t).val(1),l(2,t)},onCancel:function(){$("#shopping_edit_"+t).val(1),l(3,t)}}):l(2,t)}),$("#shopping_add_"+s[c].priceId).click(function(){l(1,this.id.substring(13))}),$("#shopping_edit_"+s[c].priceId).change(function(){var t=this.id.substring(14),e="shopping_edit_"+t,n=$("#"+e).val();n=parseInt(n),(isNaN(n)||n<0)&&(n=0),n<=0?$.confirm({text:"确定要删除此规格吗？",onOK:function(){$("#shopping_edit_"+t).val(0),l(3,t)},onCancel:function(){$("#shopping_edit_"+t).val(1),l(3,t)}}):l(3,t)}),1==s[c].isBuy?document.getElementById("shopping_isbuy_"+s[c].priceId).src="/pages/bdshop/image/choose.png":(b=!1,document.getElementById("shopping_isbuy_"+s[c].priceId).src="/pages/bdshop/image/un-choose.png"),$("#shopping_isbuy_"+s[c].priceId).click(function(){h(this.id.substring(15))}),r($("#div_"+s[c].priceId+" li"));b&&$(".text").addClass("selected"),_(),$("#clearmyshoppingcart").click(function(){m()})},error:function(e,n){t.resetload()}})}});$(".title_btn").click(function(t){"编辑"==t.target.innerHTML?($("#checkAllBtn").show(),$("#shoppingCartDetail,#settle_accounts").hide(),$(".text").addClass("selected"),p(),t.target.innerHTML="完成"):"完成"==t.target.innerHTML?($("#checkAllBtn").hide(),$("#shoppingCartDetail,#settle_accounts").show(),t.target.innerHTML="编辑"):"清空购物车"==t.target.innerHTML&&m()}),$("#shopping_isbuy_allOrNotall").click(function(){var t=$(this).parent(".text");t.hasClass("selected")?(u(2),t.removeClass("selected")):(u(1),t.addClass("selected"))}),d(),v=0,C.unlock(),C.noData(!1),C.$domDown.html(C.opts.domDown.domLoad),C.loading=!0,C.opts.loadDownFn(C)});